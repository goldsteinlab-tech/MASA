<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Leslie Cohen" />


<title>Motif-Associated Signs of Activity (MASA)</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">
body {
font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
background-color: #f9f6f3;
color: #2c2c2c;
max-width: 850px;
margin: 0 auto;
line-height: 1.6;
}
h1, h2, h3 {
color: #355C7D;
font-weight: 700;
border-bottom: 1px solid #ddd;
padding-bottom: 6px;
}
h1.title {
text-align: center;
font-size: 2.3em;
margin-top: 30px;
}
p.author {
text-align: center;
color: #6c757d;
font-size: 1.1em;
margin-bottom: 25px;
}
pre, code {
background: #f1ecec;
border-radius: 4px;
padding: 2px 6px;
color: #872258;
}
table {
border-collapse: collapse;
width: 100%;
background: #fff;
}
td, th {
border: 1px solid #e7e6e1;
padding: 8px 10px;
}
th {
background: #f2e9e2;
color: #355c7d;
}
blockquote {
border-left: 4px solid #83afd7;
background: #f6fafe;
padding: 1em;
color: #355c7d;
margin: 1em 0;
}
a {
color: #559bc7;
text-decoration: none;
}
a:hover {
text-decoration: underline;
}
</style>




</head>

<body>




<h1 class="title toc-ignore">Motif-Associated Signs of Activity (MASA)</h1>
<h4 class="author">Leslie Cohen</h4>



<p>Motif-Associated Signs of Activity (MASA) is a computational tool designed to predict which transcription factors (TFs) change their activity between two experimental conditions using ATAC-seq data. MASA is intended for biologists and bioinformaticians interested in chromatin accessibility and transcriptional regulation.</p>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
</div>
<div id="input" class="section level2">
<h2>Input:</h2>
<ul>
<li><p>BAM files (aligned ATAC-seq reads)</p></li>
<li><p>MACS2 output peak files (in BED or narrowPeak format)</p></li>
</ul>
</div>
<div id="core-functions" class="section level2">
<h2>Core Functions:</h2>
<p>MASA integrates differential accessibility, motif enrichment, and footprinting analysis to infer transcription factor activity changes between two conditions.</p>
<p>Differential accessible regions and motif enrichment: MASA identifies deferentially accessible peaks using HOMER and performs motif enrichment analysis on these regions. Enriched motifs are incorporated into the result files.</p>
<p>Footprinting and accessibility quantification. MASA calculates flanking accessibility and transcription factor footprinting metrics from ATAC-seq BAM files, comparing them between the two conditions to detect differential TF activity.</p>
<p>Differential activity scores and visualization Differential scores quantify the change in TF activity between conditions. Results are compiled into a summary table including differential activity values, and statistical significance. MASA also provides a bagplot visualization summarizing differential footprint depth, flanking accessibility, where HOMER-enriched motifs are highlighted.</p>
</div>
<div id="how-does-masa-work" class="section level2">
<h2>How Does MASA Work?</h2>
</div>
<div id="data-processing" class="section level2">
<h2>Data Processing:</h2>
<p>Reads BAM files and identifies accessible chromatin regions using MACS2 peak files.</p>
<p>Calculates chromatin accessibility and TF footprints for each condition.</p>
<p>Computes the difference (delta) in accessibility and footprinting for each TF motif between the two conditions.</p>
<p>Performs HOMER motif enrichment analysis on differentially-accessible regions.</p>
</div>
<div id="output-generation" class="section level2">
<h2>Output Generation:</h2>
<p>Produces a results table with TF scores, p-values, and other relevant statistics.</p>
<p>Generates a plot for visualizing the distribution and outliers among TF activity changes.</p>
</div>
<div id="masa-project-environment-requirements-and-structure" class="section level2">
<h2>MASA Project Environment: Requirements and Structure</h2>
<p>Before running MASA, you must organize your project files in a specific way to ensure smooth operation and reproducibility. Here’s a detailed guide on setting up your environment.</p>
</div>
<div id="required-directories" class="section level2">
<h2>1. Required Directories</h2>
<p>You need to prepare two main directories for each project:</p>
<div id="a.-merged-bam-directory" class="section level3">
<h3>a. Merged BAM Directory</h3>
<p>Contains one merged, sorted, and indexed BAM file containing all replicas per condition (e.g., treated, control).</p>
<p>Each BAM file should be accompanied by:</p>
<p>Its index file (.bai)</p>
<p>A SAMtools stats file (output from samtools idxstats file.bam | tr ‘’,’ &gt; file.csv ), named exactly like the BAM file but with a .csv extension.</p>
</div>
<div id="b.-macs2-peaks-directory" class="section level3">
<h3>b. MACS2 Peaks Directory</h3>
<p>Contains the MACS2 output files for each condition.</p>
<p>Files must be in BED or narrowPeak format.</p>
<p>Each file should represent the ATAC-seq peaks for a given condition.</p>
</div>
</div>
<div id="additional-requirements-for-homer-integration" class="section level2">
<h2>2. Additional Requirements (for HOMER Integration)</h2>
<p>If you plan to use the HOMER function (highly recommended for advanced analyses):</p>
<p>You must also provide individual BAM files for each replicate within each condition.</p>
<p>These BAM files should:</p>
<p>Be sorted and indexed.</p>
<p>Ideally, follow a consistent naming scheme: For example, if your merged BAM is control_suffix.bam, the replicates should be named control_1.bam, control_2.bam, etc.</p>
</div>
<div id="project-definition-file" class="section level2">
<h2>3. Project Definition File</h2>
<p>Each project should have a project definition file (often named environment.yaml or similar), specifying:</p>
<p>Project name</p>
<p>Path to merged BAM directory</p>
<p>Path to MACS2 peaks directory</p>
<p>Reference genome version (e.g., mm10, hg38)</p>
<p>Treatments (all_set): List of all conditions (e.g., treated, control)</p>
<p>Couples: Define the pairs of conditions you want to compare (for use in MASA)</p>
</div>
<div id="important-how-to-define-couples-in-your-project-file" class="section level2">
<h2>Important: How to Define “couples” in Your Project File</h2>
<p>In the couples section, always list the control condition first, followed by a hyphen (-), then the experimental condition (e.g., control-treated).</p>
<p>Do NOT use underscores (_)!</p>
</div>
<div id="pre-processing" class="section level2">
<h2>Pre-processing</h2>
</div>
<div id="initial-processing-and-file-generation" class="section level2">
<h2>Initial Processing and File Generation</h2>
<p>This section describes the preprocessing steps required for each condition before downstream analysis.</p>
</div>
<div id="atac-seq-signal-normalization" class="section level2">
<h2>ATAC-seq signal normalization</h2>
<div id="observed-vs.-expected-table" class="section level3">
<h3>Observed vs. Expected Table:</h3>
<p>Using the BAM files from ATAC-seq experiments, MASA calculates the observed frequency of each 6-mer at Tn5 insertion sites. It then compares these observed counts to the expected frequencies derived from a genome-wide 6-mer library, generating an observed/expected (O/E) ratio for each 6-mer.</p>
</div>
<div id="bias-factor-application" class="section level3">
<h3>Bias Factor Application:</h3>
<p>The O/E ratios serve as bias correction factors to derive expected count per position; observed counts are normalized by these expected counts. MASA applies these factors to adjust the raw ATAC-seq signal, normalizing for sequence bias before any downstream analysis (such as accessibility, footprinting, and delta calculation).</p>
</div>
<div id="step-by-step-workflow" class="section level3">
<h3>Step-by-Step Workflow</h3>
<div id="generate-nucleotide-code-files-per-chromosome" class="section level4">
<h4>1. Generate Nucleotide Code Files (Per Chromosome)</h4>
<p>For each chromosome in the reference genome (mm9, mm10, hg19, hg38), MASA generates nucleotide code files (nuccode files) that encode the hexamer (6-mer) sequence at each genomic position. These files serve as a lookup table, allowing the pipeline to quickly identify the sequence context at any position during bias correction and footprinting analysis.</p>
<p>This pre-processing step is performed once per genome and is reused across all samples and conditions, ensuring efficient and consistent sequence bias correction throughout the analysis.</p>
</div>
<div id="generate-bedgraph-files" class="section level4">
<h4>2. Generate BedGraph Files</h4>
<p>Create a BedGraph file for each condition, representing the genome-wide accessibility profile.</p>
<p>During this step, correct for Tn5 transposase offset by shifting the reads (+4 bp for the positive strand, -5 bp for the negative strand), which accurately centers the insertion sites.</p>
<p>Remove duplicate reads as part of this process.</p>
</div>
<div id="hexamer-table-construction" class="section level4">
<h4>3. Hexamer Table Construction</h4>
<p>For each condition, MASA builds a hexamer (6-mer) bias table that quantifies sequence-dependent Tn5 cutting preferences.</p>
<p>Using the nuccode files, MASA assigns to each genomic position the local hexamer sequence. The corresponding BedGraph file provides the number of Tn5 cuts at each position (after strand-specific Tn5 offset correction and duplicate removal). For every hexamer, MASA then:</p>
<ul>
<li>counts how many times it appears in the genome (GenomicPositionCount), and</li>
<li>aggregates the observed Tn5 cuts at all positions carrying this hexamer (ObCuts).</li>
</ul>
<p>The ratio</p>
<pre><code>      ObCutRatio = ObCuts / GenomicPositionCount
      </code></pre>
<p>provides an estimate of the cleavage propensity for each hexamer.</p>
<p>The hexamer bias table also includes additional normalization metrics, such as:</p>
<ul>
<li>the genomic proportion of each hexamer among all 6-mers (GPRatio), and</li>
<li>a correction factor derived from these quantities.</li>
</ul>
<p>This correction factor is used in downstream steps to rescale cut counts and remove intrinsic Tn5 sequence bias, ensuring that the resulting footprinting signal reflects true chromatin protection rather than enzymatic preference.</p>
<p>One hexamer bias table is generated per condition. For differential footprinting between two conditions (a couple), MASA later merges the per-condition tables into a combined hexamer file (see summary table), so that both conditions are normalized using the same hexamer set and bias estimates.</p>
</div>
</div>
<div id="output-files" class="section level3">
<h3>Output files</h3>
<table>
<colgroup>
<col width="15%"></col>
<col width="26%"></col>
<col width="58%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="left">Step</th>
<th align="left">Output_File</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Preprocessing</td>
<td align="left">BedGraph</td>
<td align="left">Genome-wide Accessibility profile</td>
</tr>
<tr class="even">
<td align="left">Hexamer</td>
<td align="left">nuccode + Hexamer table</td>
<td align="left">hexamer genome index + hexamer bias / frequency table</td>
</tr>
<tr class="odd">
<td align="left">Peaks</td>
<td align="left">peaks reformatted as CSV</td>
<td align="left">peaks in standardized CSV format</td>
</tr>
</tbody>
</table>
<p>When comparing two conditions (e.g., control vs treatment), MASA generates additional files that combine information from both samples. These “couple-level” outputs ensure that footprinting and accessibility differences are evaluated on a unified genomic reference.</p>
<p>Summary Table:</p>
<table>
<caption>Summary Table</caption>
<colgroup>
<col width="17%"></col>
<col width="40%"></col>
<col width="41%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="left">Step</th>
<th align="center">Output..per.condition.</th>
<th align="center">Output..per.Couple.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Generate nuccode files ** (once per genome)</td>
<td align="center">Nuccode* files (hexamer index in the genome, shared by all conditions)</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">Generate BedGraph (incl. Tn5 offset correction)</td>
<td align="center">BedGraph file (shifted)</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">Build hexamer table</td>
<td align="center">Hexamer bias file</td>
<td align="center">Combined hexamer (merge hexamer tables for both conditions)</td>
</tr>
<tr class="even">
<td align="left">Peak reformatting</td>
<td align="center">Hotspot table (MACS2 peaks reformatted to MASA format; one row per peak with placeholder footprint metrics)</td>
<td align="center">Combined peaks / pooled hotspot (merged hotspot table defining a common peaks universe for both conditions)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="running-the-script" class="section level2">
<h2>Running the script</h2>
<p>Your script should be in the directory bg_dir.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">library</span>(masa)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">library</span>(hash)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">library</span>(data.table)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">library</span>(Cairo)</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">library</span>(aplpack)</span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="kw">library</span>(stringr)</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="kw">library</span>(plotly)</span></code></pre></div>
<p>In the section outline below, we remove reads that align multiple times in the genome for each condition. This process is performed separately for each chromosome.</p>
<p>For each condition:</p>
<ul>
<li><p>A BedGraph file is created.</p></li>
<li><p>Tn5 offset is corrected by shifting the reads in the BedGraph.</p></li>
<li><p>A hexamer table is generated.</p></li>
</ul>
<p>This step will produce:</p>
<ol style="list-style-type: upper-alpha">
<li>Per treatment/condition (one set per sample):</li>
</ol>
<ul>
<li><p>BedGraph: Genome-wide accessibility profile file (Tn5-shifted).</p></li>
<li><p>Hexamer file and the corresponding nuccode* files.</p></li>
<li><p>Peak file reformatted to a standardized CSV table.</p></li>
</ul>
<ol start="2" style="list-style-type: upper-alpha">
<li>Pair of conditions (couple):</li>
</ol>
<ul>
<li><p>Combined peaks: Merged peak regions defining a shared peak universe for both conditions.</p></li>
<li><p>Combined hexamer: Merged hexamer bias tables used for comparative analysis between conditions.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">setwd</span>(bg_dir)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="cf">for</span> (treat <span class="cf">in</span> all_set) {</span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="co"># Build BAM file path</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  bamfile &lt;-<span class="st"> </span><span class="kw">file.path</span>(bam_dir, <span class="kw">paste0</span>(treat, <span class="st">&quot;.sorted.bam&quot;</span>))</span>
<span id="cb3-7"><a href="#cb3-7"></a>  </span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="co"># Count the number of cuts in the BAM file</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  cc &lt;-<span class="st"> </span><span class="kw">countReadsBAM</span>(bamfile, mm)</span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;treat:&quot;</span>, treat, <span class="st">&quot;cc:&quot;</span>, cc))</span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="kw">assign</span>(<span class="kw">paste0</span>(<span class="st">&quot;cc_&quot;</span>, treat), cc)</span>
<span id="cb3-12"><a href="#cb3-12"></a>  </span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="co"># Generate a BedGraph file with cleavage counts</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>   cutcountfile =<span class="st"> </span><span class="kw">makeCutCountBAMWithName</span>(bamfile, </span>
<span id="cb3-15"><a href="#cb3-15"></a>                                         <span class="dt">name =</span>  <span class="kw">basenameWithoutExt</span>(bamfile),</span>
<span id="cb3-16"><a href="#cb3-16"></a>                                         <span class="dt">refgenome=</span>mm) </span>
<span id="cb3-17"><a href="#cb3-17"></a>  </span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="co"># Tn5 insertion bias correction</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>   hex_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, treat, <span class="st">&quot;_&quot;</span>, mm, <span class="st">&quot;.txt&quot;</span>))</span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="kw">message</span>(<span class="st">&quot;Checking Hexamer file: &quot;</span>, hex_file)</span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="kw">message</span>(<span class="st">&quot;Exists? &quot;</span>, <span class="kw">file.exists</span>(hex_file))</span>
<span id="cb3-22"><a href="#cb3-22"></a>   <span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(hex_file)) {</span>
<span id="cb3-23"><a href="#cb3-23"></a>    <span class="kw">message</span>(<span class="st">&quot;Creating Hexamer table (and possibly nuccode) for &quot;</span>, treat, <span class="st">&quot; ...&quot;</span>)</span>
<span id="cb3-24"><a href="#cb3-24"></a>     </span>
<span id="cb3-25"><a href="#cb3-25"></a>  tab =<span class="st"> </span><span class="kw">MakeBiasCorrectionTableBAM</span>(</span>
<span id="cb3-26"><a href="#cb3-26"></a>  <span class="dt">bamfile=</span>bamfile,</span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="dt">outfile=</span><span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>,treat,<span class="st">&quot;_mm10.txt&quot;</span>),</span>
<span id="cb3-28"><a href="#cb3-28"></a>  <span class="dt">refgenome=</span><span class="st">&quot;mm10&quot;</span>,</span>
<span id="cb3-29"><a href="#cb3-29"></a>  <span class="dt">np=</span><span class="dv">6</span>,</span>
<span id="cb3-30"><a href="#cb3-30"></a>  <span class="dt">atac=</span>T   )  <span class="co"># Set TRUE for ATAC data. The default value is FALSE</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>  </span>
<span id="cb3-32"><a href="#cb3-32"></a>   } <span class="cf">else</span> {</span>
<span id="cb3-33"><a href="#cb3-33"></a>    <span class="kw">message</span>(<span class="st">&quot;Hexamer file already exists for &quot;</span>, treat, <span class="st">&quot; -&gt; skipping bias table generation.&quot;</span>)</span>
<span id="cb3-34"><a href="#cb3-34"></a>   }</span>
<span id="cb3-35"><a href="#cb3-35"></a>   </span>
<span id="cb3-36"><a href="#cb3-36"></a>   </span>
<span id="cb3-37"><a href="#cb3-37"></a>  <span class="co"># Read MACS2 peaks and convert to CSV</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>  macs &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(macs2_dir, <span class="kw">paste0</span>(treat, <span class="st">&quot;_peaks.narrowPeak&quot;</span>)),</span>
<span id="cb3-39"><a href="#cb3-39"></a>                   <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb3-40"><a href="#cb3-40"></a>  <span class="kw">names</span>(macs)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;chr&#39;</span>, <span class="st">&#39;st&#39;</span>, <span class="st">&#39;ed&#39;</span>)</span>
<span id="cb3-41"><a href="#cb3-41"></a>  nr &lt;-<span class="st"> </span><span class="kw">nrow</span>(macs)</span>
<span id="cb3-42"><a href="#cb3-42"></a>  </span>
<span id="cb3-43"><a href="#cb3-43"></a>  <span class="co"># Create a hotspot data frame for each peak</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>  hotspot &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb3-45"><a href="#cb3-45"></a>    <span class="dt">ID =</span> <span class="dv">1</span><span class="op">:</span>nr, <span class="dt">chrom. =</span> macs<span class="op">$</span>chr, <span class="dt">start =</span> macs<span class="op">$</span>st <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">end =</span> macs<span class="op">$</span>ed,</span>
<span id="cb3-46"><a href="#cb3-46"></a>    <span class="dt">MaxD =</span> <span class="kw">rep</span>(<span class="dv">0</span>, nr),</span>
<span id="cb3-47"><a href="#cb3-47"></a>    <span class="dt">AveD =</span> <span class="kw">rep</span>(<span class="dv">0</span>, nr),</span>
<span id="cb3-48"><a href="#cb3-48"></a>    <span class="dt">Zscore =</span> <span class="kw">rep</span>(<span class="dv">0</span>, nr),</span>
<span id="cb3-49"><a href="#cb3-49"></a>    <span class="dt">pvalue =</span> <span class="kw">rep</span>(<span class="dv">0</span>, nr)</span>
<span id="cb3-50"><a href="#cb3-50"></a>  )</span>
<span id="cb3-51"><a href="#cb3-51"></a>  </span>
<span id="cb3-52"><a href="#cb3-52"></a>  <span class="co"># Write the hotspot table to CSV</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>  <span class="kw">write.table</span>(hotspot, <span class="dt">file =</span> <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(treat, <span class="st">&quot;_peaks.csv&quot;</span>)), <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb3-54"><a href="#cb3-54"></a>}</span>
<span id="cb3-55"><a href="#cb3-55"></a></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="co"># Remove temporary files</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>temp &lt;-<span class="st"> </span><span class="kw">list.files</span>(bg_dir,</span>
<span id="cb3-58"><a href="#cb3-58"></a>                   <span class="dt">pattern =</span> <span class="kw">glob2rx</span>(<span class="st">&quot;temp*.dat&quot;</span>),</span>
<span id="cb3-59"><a href="#cb3-59"></a>                   <span class="dt">recursive =</span> <span class="ot">TRUE</span>,</span>
<span id="cb3-60"><a href="#cb3-60"></a>                   <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-61"><a href="#cb3-61"></a><span class="kw">file.remove</span>(temp)</span>
<span id="cb3-62"><a href="#cb3-62"></a></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co"># Merge files for MASA run</span></span>
<span id="cb3-64"><a href="#cb3-64"></a><span class="cf">for</span> (c <span class="cf">in</span> couples) {</span>
<span id="cb3-65"><a href="#cb3-65"></a>  <span class="kw">print</span>(c)</span>
<span id="cb3-66"><a href="#cb3-66"></a>  set1 &lt;-<span class="st"> </span><span class="kw">strsplit</span>(c, <span class="st">&quot;-&quot;</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>]</span>
<span id="cb3-67"><a href="#cb3-67"></a>  set2 &lt;-<span class="st"> </span><span class="kw">strsplit</span>(c, <span class="st">&quot;-&quot;</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb3-68"><a href="#cb3-68"></a>  </span>
<span id="cb3-69"><a href="#cb3-69"></a>  <span class="co"># Combine hotspots for the two conditions</span></span>
<span id="cb3-70"><a href="#cb3-70"></a>  <span class="kw">assign</span>(</span>
<span id="cb3-71"><a href="#cb3-71"></a>    <span class="kw">paste0</span>(set1, <span class="st">&quot;_&quot;</span>, set2, <span class="st">&quot;_peaks&quot;</span>),</span>
<span id="cb3-72"><a href="#cb3-72"></a>    <span class="kw">combineTwoHotspots</span>(</span>
<span id="cb3-73"><a href="#cb3-73"></a>      <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(set1, <span class="st">&quot;_peaks.csv&quot;</span>)),</span>
<span id="cb3-74"><a href="#cb3-74"></a>      <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(set2, <span class="st">&quot;_peaks.csv&quot;</span>)),</span>
<span id="cb3-75"><a href="#cb3-75"></a>      set1, set2</span>
<span id="cb3-76"><a href="#cb3-76"></a>    )</span>
<span id="cb3-77"><a href="#cb3-77"></a>  )</span>
<span id="cb3-78"><a href="#cb3-78"></a>  </span>
<span id="cb3-79"><a href="#cb3-79"></a>  <span class="co"># Read and clean pooled hotspot file</span></span>
<span id="cb3-80"><a href="#cb3-80"></a>  pooled_path &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;pooled_&quot;</span>, set1, <span class="st">&quot;_&quot;</span>, set2, <span class="st">&quot;_hotspot.csv&quot;</span>))</span>
<span id="cb3-81"><a href="#cb3-81"></a>  pooled &lt;-<span class="st"> </span><span class="kw">read.csv</span>(pooled_path)</span>
<span id="cb3-82"><a href="#cb3-82"></a>  <span class="cf">if</span> (<span class="st">&quot;ID.1&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(pooled)) {</span>
<span id="cb3-83"><a href="#cb3-83"></a>    pooled &lt;-<span class="st"> </span>pooled <span class="op">%&gt;%</span></span>
<span id="cb3-84"><a href="#cb3-84"></a><span class="st">      </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>ID<span class="fl">.1</span>)</span>
<span id="cb3-85"><a href="#cb3-85"></a>    <span class="kw">write.csv</span>(pooled, pooled_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb3-86"><a href="#cb3-86"></a>  }</span>
<span id="cb3-87"><a href="#cb3-87"></a>  </span>
<span id="cb3-88"><a href="#cb3-88"></a>  <span class="co"># Merge the hexamer frequency tables for the two conditions</span></span>
<span id="cb3-89"><a href="#cb3-89"></a>  <span class="kw">assign</span>(</span>
<span id="cb3-90"><a href="#cb3-90"></a>    <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, set1, <span class="st">&quot;_&quot;</span>, set2),</span>
<span id="cb3-91"><a href="#cb3-91"></a>    <span class="kw">merge_two_frequency_tables</span>(</span>
<span id="cb3-92"><a href="#cb3-92"></a>      <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, set1, <span class="st">&quot;_&quot;</span>, mm, <span class="st">&quot;.txt&quot;</span>)),</span>
<span id="cb3-93"><a href="#cb3-93"></a>      <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, set2, <span class="st">&quot;_&quot;</span>, mm, <span class="st">&quot;.txt&quot;</span>)),</span>
<span id="cb3-94"><a href="#cb3-94"></a>      <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, set1, <span class="st">&quot;_&quot;</span>, set2, <span class="st">&quot;_merged.csv&quot;</span>))</span>
<span id="cb3-95"><a href="#cb3-95"></a>    )</span>
<span id="cb3-96"><a href="#cb3-96"></a>  )</span>
<span id="cb3-97"><a href="#cb3-97"></a>}</span></code></pre></div>
</div>
<div id="homer-differential-atac-seq-analysis-motif-enrichment" class="section level2">
<h2>HOMER : Differential ATAC-seq analysis &amp; motif enrichment</h2>
</div>
<div id="run-homer" class="section level2">
<h2>Run HOMER</h2>
<p>To use this part of the workflow with MASA, it is essential to have HOMER installed on your system, following the official recommendations provided on the HOMER installation page:</p>
<p><a href="http://homer.ucsd.edu/homer/introduction/install.htm" class="uri">http://homer.ucsd.edu/homer/introduction/install.htm</a></p>
<p>Please make sure to carefully follow the instructions on the official HOMER website to ensure a correct installation and full access to all required features.</p>
<p>With MASA, it is highly recommended to run HOMER to perform motif analysis on deferentially accessible ATAC-seq peaks.</p>
<p>Integrating HOMER allows you to identify transcription factor motifs that are enriched in regions showing differential accessibility between conditions.</p>
<p>In this chunk, the workflow proceeds as follows:</p>
<ul>
<li><p>Load the peak files and all BAM files for each replicate within every condition.</p></li>
<li><p>Use HOMER to count the number of tags per peak for each replicate.</p></li>
<li><p>Normalize these counts across replicates and conditions.</p></li>
<li><p>Perform differential analysis with DESeq2 via HOMER, generating an annotated file of differentially accessible peaks.</p></li>
<li><p>For these differential peaks, run motif enrichment analysis with HOMER.</p></li>
</ul>
<p>The results of the motif enrichment analysis are displayed as gold rings in MASA’s final plot (pdf zoom in, pdf zoom out, jpg, svg, html). In addition, motif enrichment p value threshold for each motif appears and in the MASA output table.</p>
<p><a href="http://homer.ucsd.edu/homer/introduction/install.html" class="uri">http://homer.ucsd.edu/homer/introduction/install.html</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># ============================</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># SETTINGS</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># ============================</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># Path to the HOMER binary directory</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>homer_bin &lt;-<span class="st"> &quot;/home/leslieco/software/homer/bin/&quot;</span></span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co"># Directory containing all BAM files (replicates)</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>work_dir &lt;-<span class="st"> </span>bam_dir</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co"># Peak file merged from previous MASA steps</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>merged_peak &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;pooled_fasted_fed_hotspot_modify.txt&quot;</span>)</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># Directory for HOMER output</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>output_dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;homer_res_&quot;</span>, project))</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># Output file for annotatePeak.pl</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>annotate_outfile &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;fasted_annot.txt&quot;</span>)</span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co"># Output file for getDiffExpression.pl</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>diffexp_outfile &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;fasted_output.txt&quot;</span>)</span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co"># Reference genome (e.g., mm10, hg38)</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>genome &lt;-<span class="st"> &quot;mm10&quot;</span></span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co"># Replicate groups for getDiffExpression.pl (adapt as needed)</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>group1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fed&quot;</span>, <span class="st">&quot;fed&quot;</span>, <span class="st">&quot;fed&quot;</span>) <span class="co"># 3 replicas </span></span>
<span id="cb4-30"><a href="#cb4-30"></a>group2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fasted&quot;</span>, <span class="st">&quot;fasted&quot;</span>, <span class="st">&quot;fasted&quot;</span>) <span class="co"># 3 replicas </span></span>
<span id="cb4-31"><a href="#cb4-31"></a></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="co"># Reformat the merged peak file for HOMER</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>input_file1 &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;pooled_fasted_hotspot.csv&quot;</span>)</span>
<span id="cb4-34"><a href="#cb4-34"></a>output_file1 &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;pooled_fasted_hotspot_modify.txt&quot;</span>)</span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="kw">process_hotspot_file</span>(</span>
<span id="cb4-37"><a href="#cb4-37"></a>  input_file1,</span>
<span id="cb4-38"><a href="#cb4-38"></a>  output_file1</span>
<span id="cb4-39"><a href="#cb4-39"></a>)</span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="kw">library</span>(<span class="st">&quot;DESeq2&quot;</span>)</span>
<span id="cb4-42"><a href="#cb4-42"></a></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="co"># 1. Create tag directories for each BAM file (replicate)</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="co"># This will create tag directories in the merged BAM directory</span></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="co"># BAM files must be named with the pattern &quot;_[0-9].bam&quot;</span></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co"># Can take more than 30 min</span></span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a><span class="co"># PATH expected for the Tag Directories</span></span>
<span id="cb4-49"><a href="#cb4-49"></a></span>
<span id="cb4-50"><a href="#cb4-50"></a>bam_files_all &lt;-<span class="st"> </span><span class="kw">list.files</span>(work_dir, <span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.bam$&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-51"><a href="#cb4-51"></a>bam_files &lt;-<span class="st"> </span>bam_files_all[<span class="kw">grepl</span>(<span class="st">&quot;[0-9]</span><span class="ch">\\</span><span class="st">.bam$&quot;</span>, bam_files_all)]</span>
<span id="cb4-52"><a href="#cb4-52"></a>td_paths &lt;-<span class="st">  </span><span class="kw">file.path</span>(work_dir, <span class="kw">paste0</span>(<span class="st">&quot;TD_&quot;</span>, <span class="kw">sub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.bam$&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">basename</span>(bam_files))))</span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="co"># Check of TDs</span></span>
<span id="cb4-55"><a href="#cb4-55"></a><span class="cf">if</span> (<span class="kw">all</span>(<span class="kw">dir.exists</span>(td_paths))) {</span>
<span id="cb4-56"><a href="#cb4-56"></a>  <span class="kw">message</span>(<span class="st">&quot;All Tag Directories already exist, skipping creation.&quot;</span>)</span>
<span id="cb4-57"><a href="#cb4-57"></a>  td_dirs &lt;-<span class="st"> </span>td_paths</span>
<span id="cb4-58"><a href="#cb4-58"></a>} <span class="cf">else</span> {</span>
<span id="cb4-59"><a href="#cb4-59"></a>  td_dirs &lt;-<span class="st"> </span><span class="kw">create_tag_directories</span>(</span>
<span id="cb4-60"><a href="#cb4-60"></a>  homer_bin ,</span>
<span id="cb4-61"><a href="#cb4-61"></a>  work_dir ,</span>
<span id="cb4-62"><a href="#cb4-62"></a>  <span class="dt">condition_order =</span> <span class="kw">c</span>(<span class="st">&quot;fed&quot;</span>, <span class="st">&quot;fasted&quot;</span>),  <span class="co"># control first, treatment second !!!</span></span>
<span id="cb4-63"><a href="#cb4-63"></a>  <span class="dt">verbose =</span> <span class="ot">TRUE</span></span>
<span id="cb4-64"><a href="#cb4-64"></a>)</span>
<span id="cb4-65"><a href="#cb4-65"></a>}</span>
<span id="cb4-66"><a href="#cb4-66"></a></span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="co"># 2. Peak annotation using HOMER</span></span>
<span id="cb4-69"><a href="#cb4-69"></a><span class="co"># This will generate an annotation file in bg_dir</span></span>
<span id="cb4-70"><a href="#cb4-70"></a><span class="kw">run_annotate_peak</span>(</span>
<span id="cb4-71"><a href="#cb4-71"></a>  homer_bin,</span>
<span id="cb4-72"><a href="#cb4-72"></a>  work_dir,</span>
<span id="cb4-73"><a href="#cb4-73"></a>  output_file1,</span>
<span id="cb4-74"><a href="#cb4-74"></a>  genome,</span>
<span id="cb4-75"><a href="#cb4-75"></a>  td_dirs,</span>
<span id="cb4-76"><a href="#cb4-76"></a>  annotate_outfile</span>
<span id="cb4-77"><a href="#cb4-77"></a>)</span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a><span class="co"># 3. Differential analysis with HOMER</span></span>
<span id="cb4-80"><a href="#cb4-80"></a><span class="co"># This will generate a diff expression file in bg_dir</span></span>
<span id="cb4-81"><a href="#cb4-81"></a><span class="kw">run_diff_expression</span>(</span>
<span id="cb4-82"><a href="#cb4-82"></a>  homer_bin,</span>
<span id="cb4-83"><a href="#cb4-83"></a>  work_dir,</span>
<span id="cb4-84"><a href="#cb4-84"></a>  annotate_outfile,</span>
<span id="cb4-85"><a href="#cb4-85"></a>  diffexp_outfile,</span>
<span id="cb4-86"><a href="#cb4-86"></a>  group1,</span>
<span id="cb4-87"><a href="#cb4-87"></a>  group2</span>
<span id="cb4-88"><a href="#cb4-88"></a>)</span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="co"># 4. Create a file with only differential peaks (BED format and table with l2fc, padj, pval) in work_dir(bam_merged)</span></span>
<span id="cb4-91"><a href="#cb4-91"></a></span>
<span id="cb4-92"><a href="#cb4-92"></a>diffexp_outfile1&lt;-<span class="st">&quot;fasted_output.txt&quot;</span></span>
<span id="cb4-93"><a href="#cb4-93"></a></span>
<span id="cb4-94"><a href="#cb4-94"></a><span class="kw">create_diff_peak_files</span>(</span>
<span id="cb4-95"><a href="#cb4-95"></a>  <span class="dt">input_path =</span> bg_dir,</span>
<span id="cb4-96"><a href="#cb4-96"></a>  <span class="dt">input_filename =</span> diffexp_outfile1,</span>
<span id="cb4-97"><a href="#cb4-97"></a>  <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,</span>
<span id="cb4-98"><a href="#cb4-98"></a>  <span class="dt">chr =</span> <span class="st">&quot;Chr&quot;</span>,</span>
<span id="cb4-99"><a href="#cb4-99"></a>  <span class="dt">start =</span> <span class="st">&quot;Start&quot;</span>,</span>
<span id="cb4-100"><a href="#cb4-100"></a>  <span class="dt">end =</span> <span class="st">&quot;End&quot;</span>,</span>
<span id="cb4-101"><a href="#cb4-101"></a>  <span class="dt">padj_cutoff =</span> <span class="fl">0.05</span>, <span class="co"># adjust as needed</span></span>
<span id="cb4-102"><a href="#cb4-102"></a>  <span class="dt">l2fc_cutoff =</span> <span class="fl">0.5</span>,    <span class="co"># adjust as needed</span></span>
<span id="cb4-103"><a href="#cb4-103"></a>  <span class="dt">output_prefix =</span> <span class="st">&quot;my_peaks&quot;</span></span>
<span id="cb4-104"><a href="#cb4-104"></a>)</span>
<span id="cb4-105"><a href="#cb4-105"></a></span>
<span id="cb4-106"><a href="#cb4-106"></a><span class="co"># copy the BED file (not usually necessary in R, but shown for completeness) to bg_dir</span></span>
<span id="cb4-107"><a href="#cb4-107"></a><span class="kw">file.copy</span>(</span>
<span id="cb4-108"><a href="#cb4-108"></a>  <span class="dt">from =</span> <span class="kw">file.path</span>(work_dir, <span class="st">&quot;my_peaks_simple.bed&quot;</span>),</span>
<span id="cb4-109"><a href="#cb4-109"></a>  <span class="dt">to =</span> <span class="kw">file.path</span>(bg_dir, <span class="st">&quot;my_peaks_simple.bed&quot;</span>),</span>
<span id="cb4-110"><a href="#cb4-110"></a>  <span class="dt">overwrite =</span> <span class="ot">TRUE</span></span>
<span id="cb4-111"><a href="#cb4-111"></a>)</span>
<span id="cb4-112"><a href="#cb4-112"></a></span>
<span id="cb4-113"><a href="#cb4-113"></a><span class="co"># 5. Run HOMER motif enrichment</span></span>
<span id="cb4-114"><a href="#cb4-114"></a>input_bed &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;my_peaks_simple.bed&quot;</span>)</span>
<span id="cb4-115"><a href="#cb4-115"></a>output_folder &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;homer_motif_res&quot;</span>)</span>
<span id="cb4-116"><a href="#cb4-116"></a>genome_build &lt;-<span class="st"> &quot;mm10&quot;</span></span>
<span id="cb4-117"><a href="#cb4-117"></a>homer_exe &lt;-<span class="st"> </span><span class="kw">file.path</span>(homer_bin, <span class="st">&quot;findMotifsGenome.pl&quot;</span>)</span>
<span id="cb4-118"><a href="#cb4-118"></a></span>
<span id="cb4-119"><a href="#cb4-119"></a>MASA_DIR &lt;-<span class="st"> &quot;/home/leslieco/masa/&quot;</span>  <span class="co"># &lt;-- User edits this line for their install</span></span>
<span id="cb4-120"><a href="#cb4-120"></a>motif_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(MASA_DIR, <span class="st">&quot;/inst/data/all_cluster_motifs.motifs&quot;</span>)</span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a>extra_args1 &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;-mknown &quot;</span>, motif_file)</span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a><span class="co"># homer enrichment , can take more than 30min</span></span>
<span id="cb4-125"><a href="#cb4-125"></a><span class="kw">run_homer</span>(</span>
<span id="cb4-126"><a href="#cb4-126"></a>  input_bed,</span>
<span id="cb4-127"><a href="#cb4-127"></a>  output_folder,</span>
<span id="cb4-128"><a href="#cb4-128"></a>  genome_build,</span>
<span id="cb4-129"><a href="#cb4-129"></a>  homer_exe,</span>
<span id="cb4-130"><a href="#cb4-130"></a>  extra_args1</span>
<span id="cb4-131"><a href="#cb4-131"></a>)</span></code></pre></div>
</div>
<div id="masa-processing-footprinting-and-tf-activity-inference" class="section level2">
<h2>MASA Processing: Footprinting and TF Activity Inference</h2>
<p>In the final step, MASA integrates all precomputed inputs to quantify transcription factor (TF) activity differences between conditions. For each condition pair, MASA performs sequence-bias–corrected footprinting over all genomic motif occurrences and summarizes the results using a bagplot.</p>
<div id="input-objects" class="section level3">
<h3>Input objects</h3>
<p>For each condition, a <code>CutCount</code> object is created from the ATAC-seq BedGraph file (<code>*_AC_cutcount.bgr.gz</code>).</p>
<p>These objects store Tn5-shifted cut profiles and are used as the control and treatment signals in the footprinting &amp; flanking accessibility analysis.</p>
<p>In addition, MASA loads:</p>
<ul>
<li><p>MotifDB : archetype motif occurrence coordinates derived from a FIMO genome-wide scan. These files (mm10_files_v1.0.tar.gz, hg19_files_v1.0.tar.gz) are available here: <a href="https://doi.org/10.5281/zenodo.18182843" class="uri">https://doi.org/10.5281/zenodo.18182843</a></p></li>
<li><p>Merged hexamer bias table (<code>Hexamer_set1_set2_merged.csv</code>): used for sequence-bias correction.</p></li>
<li><p><strong>Pooled hotspot file</strong> (<code>pooled_set1_set2_hotspot.csv</code>): merged peak regions defining the common universe of sites where footprint are calculated.</p></li>
</ul>
</div>
<div id="running-masa-by-motif-batches" class="section level3">
<h3>Running MASA by motif batches</h3>
<p>For each couple of conditions (e.g., <code>fed</code> vs <code>fasted</code>), MASA constructs a <code>GFootOption</code> object specifying:</p>
<ul>
<li><p>the merged hexamer bias file, and</p></li>
<li><p>the hexamer index pattern (<code>nuccode{genome}6mer{chr}.dat</code>).</p></li>
</ul>
<p>The nuccode files were generated for mm10 (mm10_nuccode_v1.0.tar.gz) and hg19 (hg19_nuccode_v1.0.tar.gz), and available here: <a href="https://doi.org/10.5281/zenodo.18182843" class="uri">https://doi.org/10.5281/zenodo.18182843</a></p>
<p>The main footprinting routine is performed with the <code>GFoot()</code> function:</p>
<ul>
<li><p><code>control</code> and <code>treatment</code> correspond to the two <code>CutCount</code> objects,</p></li>
<li><p><code>sitefile</code> points to the pooled hotspot file (merged peaks),</p></li>
<li><p><code>motifDB</code> provides genomic coordinates of archetype motif occurrences,</p></li>
<li><p><code>gfootoption</code> controls bias correction and hexamer handling,</p></li>
<li><p><code>outputdir</code> and <code>cachedir</code> store intermediate and final results.</p></li>
</ul>
<p>To make the computation efficient, motifs are processed in <strong>batches of 25</strong>.<br />
The script automatically detects any existing <code>*_footprint_depth_table.csv</code> files and resumes from the next motif index if a previous run was interrupted. This restart mechanism is driven by the <code>start_motif</code> variable.</p>
<p>The <code>run()</code> function applies GFoot to all motifs in the specified range, using:</p>
<ul>
<li><p><code>mc.cores</code> to parallelize over CPU cores,</p></li>
<li><p><code>graphout = TRUE</code> to generate footprint plots,</p></li>
<li><p><code>yrange</code> to harmonize the y-axis scale across motifs.</p></li>
</ul>
</div>
<div id="flanking-and-central-accessibility" class="section level3">
<h3>Flanking and central accessibility</h3>
<p>For each motif occurrence, MASA quantifies:</p>
<ul>
<li><p>central accessibility: Tn5 cuts over the motif core, where a footprint may appear, and</p></li>
<li><p>flanking accessibility: Tn5 cuts in the surrounding regions, providing a local background reference.</p></li>
</ul>
<p>These signals are integrated into three likelihood-ratio statistics:</p>
<ul>
<li><p>lrmotif — accessibility change at the motif center,</p></li>
<li><p>lrflanking — accessibility change in the surrounding regions,</p></li>
<li><p>lrtotal — combined statistic (motif + flanks), used to assess TF activity shifts.</p></li>
</ul>
<p>This flanking-versus-center framework ensures that footprint depth reflects true binding-dependent protection rather than broader chromatin accessibility changes.</p>
</div>
<div id="merging-footprint-tables" class="section level3">
<h3>Merging footprint tables</h3>
<p>Each batch produces a separate <code>*_footprint_depth_table.csv</code> file.</p>
<p>After all batches are completed, these files are concatenated into a single merged table:</p>
<ul>
<li><code>*_hotspot_footprint_depth_table_merged.csv</code></li>
</ul>
<p>This table contains, for each motif:</p>
<ul>
<li><p>footprint depths in control and treatment (<code>fdepth1</code>, <code>fdepth2</code>),</p></li>
<li><p>mean cut counts (<code>meancc1</code>, <code>meancc2</code>),</p></li>
<li><p>likelihood-ratio statistics derived from central and flanking accessibility (<code>lrmotif</code>, <code>lrflanking</code>, <code>lrtotal</code>),</p></li>
<li><p>the number of motif sites used (<code>numsite</code>).</p></li>
</ul>
</div>
<div id="visualization-and-integration-with-homer" class="section level3">
<h3>Visualization and integration with HOMER</h3>
<p>To summarize TF activity changes, MASA calls <code>gen_bagplot_masa()</code> function. This step:</p>
<ul>
<li><p>generates a <strong>plot</strong>, where each point corresponds to a motif/TF,</p></li>
<li><p>highlights motifs with significant differential footprinting (based on q-values),</p></li>
<li><p>optionally annotates motifs using HOMER motif enrichment results based on archetype motifs (<code>knownResults.txt</code>), allowing the user to cross-reference footprint-based activity changes with motif enrichment p-values.</p></li>
</ul>
<p>Both <strong>PDF</strong> and <strong>HTML</strong> reports are generated, providing an interactive overview of TFs that gain or lose activity between the two conditions.</p>
<p>Finally, <code>sessionInfo()</code> is printed to record the R environment and package versions used in the analysis, ensuring full reproducibility of the MASA run.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># Set working directory to bg_dir</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>knitr<span class="op">::</span>opts_knit<span class="op">$</span><span class="kw">set</span>(<span class="dt">root.dir =</span> <span class="st">&quot;/home/leslieco/bg_files_fed_fasted/&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co"># Load libraries </span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="kw">library</span>(masa)</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="kw">library</span>(dplyr,tidyr)</span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="kw">library</span>(stringr)</span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="kw">library</span>(ggExtra)</span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="kw">library</span>(plotly)</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co"># Base directories </span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a>bg_dir &lt;-<span class="st"> &quot;/home/leslieco/bg_files_fed_fasted/&quot;</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>mm_files_dir &lt;-<span class="st"> &quot;/home/leslieco/mm10_files/&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>mm &lt;-<span class="st"> &quot;mm10&quot;</span></span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co"># Analysis parameters </span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a>numcores &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>motif_no &lt;-<span class="st"> </span><span class="dv">577</span> <span class="co"># total number of motifs in motifDB. This number should not be changed</span></span>
<span id="cb5-25"><a href="#cb5-25"></a></span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co"># Treatments and couples </span></span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a>all_set &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fed&quot;</span>, <span class="st">&quot;fasted&quot;</span>)</span>
<span id="cb5-30"><a href="#cb5-30"></a>couples &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fed-fasted&quot;</span>)</span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co"># HOMER motif results </span></span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a>homer_results_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(bg_dir, <span class="st">&quot;homer_motif_res&quot;</span>, <span class="st">&quot;knownResults.txt&quot;</span>)</span>
<span id="cb5-35"><a href="#cb5-35"></a></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co"># Load motif database (FIMO-based archetype motif scan results) </span></span>
<span id="cb5-37"><a href="#cb5-37"></a></span>
<span id="cb5-38"><a href="#cb5-38"></a>motifdb_mm &lt;-<span class="st"> </span><span class="kw">MotifDB</span>(</span>
<span id="cb5-39"><a href="#cb5-39"></a><span class="dt">motiflistfile =</span> <span class="kw">file.path</span>(mm_files_dir, <span class="kw">paste0</span>(<span class="st">&quot;motiflist_&quot;</span>, mm, <span class="st">&quot;_cluster.txt&quot;</span>)),</span>
<span id="cb5-40"><a href="#cb5-40"></a><span class="dt">directory =</span> <span class="kw">file.path</span>(mm_files_dir, <span class="kw">paste0</span>(mm, <span class="st">&quot;_cluster_fimo&quot;</span>))</span>
<span id="cb5-41"><a href="#cb5-41"></a>)</span>
<span id="cb5-42"><a href="#cb5-42"></a></span>
<span id="cb5-43"><a href="#cb5-43"></a><span class="co"># Initialize CutCount object from BedGraph files </span></span>
<span id="cb5-44"><a href="#cb5-44"></a><span class="co"># Each CutCount object stores ATAC-seq cut profiles for a given condition</span></span>
<span id="cb5-45"><a href="#cb5-45"></a></span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="cf">for</span> (treat <span class="cf">in</span> all_set) {</span>
<span id="cb5-47"><a href="#cb5-47"></a>  <span class="kw">assign</span>(</span>
<span id="cb5-48"><a href="#cb5-48"></a>  treat,</span>
<span id="cb5-49"><a href="#cb5-49"></a>  <span class="kw">CutCount</span>(</span>
<span id="cb5-50"><a href="#cb5-50"></a>  <span class="dt">file =</span> <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(treat, <span class="st">&quot;_AC_cutcount.bgr.gz&quot;</span>)),</span>
<span id="cb5-51"><a href="#cb5-51"></a>  <span class="dt">count =</span> <span class="dv">1</span>,</span>
<span id="cb5-52"><a href="#cb5-52"></a>  <span class="dt">name =</span> treat))</span>
<span id="cb5-53"><a href="#cb5-53"></a>}</span>
<span id="cb5-54"><a href="#cb5-54"></a></span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="co"># Run MASA to generate footprint_depth_table files per couple </span></span>
<span id="cb5-56"><a href="#cb5-56"></a></span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="cf">for</span> (c <span class="cf">in</span> couples) {</span>
<span id="cb5-58"><a href="#cb5-58"></a>  <span class="kw">message</span>(<span class="st">&quot;Processing couple: &quot;</span>, c)</span>
<span id="cb5-59"><a href="#cb5-59"></a></span>
<span id="cb5-60"><a href="#cb5-60"></a>  set1 &lt;-<span class="st"> </span><span class="kw">strsplit</span>(c, <span class="st">&quot;-&quot;</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>] <span class="co"># control condition</span></span>
<span id="cb5-61"><a href="#cb5-61"></a>  set2 &lt;-<span class="st"> </span><span class="kw">strsplit</span>(c, <span class="st">&quot;-&quot;</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>] <span class="co"># treatment condition</span></span>
<span id="cb5-62"><a href="#cb5-62"></a></span>
<span id="cb5-63"><a href="#cb5-63"></a><span class="co"># Define bias-correction options using the merged hexamer table</span></span>
<span id="cb5-64"><a href="#cb5-64"></a>  gfootoption_couple &lt;-<span class="st"> </span><span class="kw">GFootOption</span>(</span>
<span id="cb5-65"><a href="#cb5-65"></a>  <span class="dt">biasfile =</span> <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;Hexamer_&quot;</span>, set1, <span class="st">&quot;_&quot;</span>, set2, <span class="st">&quot;_merged.csv&quot;</span>)),</span>
<span id="cb5-66"><a href="#cb5-66"></a>  <span class="dt">hexamer_pattern =</span> <span class="kw">paste0</span>(<span class="st">&quot;nuccode&quot;</span>, mm, <span class="st">&quot;6mer{chr}.dat&quot;</span>)</span>
<span id="cb5-67"><a href="#cb5-67"></a>  )</span>
<span id="cb5-68"><a href="#cb5-68"></a>  </span>
<span id="cb5-69"><a href="#cb5-69"></a>  <span class="kw">setwd</span>(bg_dir)</span>
<span id="cb5-70"><a href="#cb5-70"></a></span>
<span id="cb5-71"><a href="#cb5-71"></a><span class="co"># Check whether footprint_depth_table outputs already exist (In case a restart was forced)</span></span>
<span id="cb5-72"><a href="#cb5-72"></a></span>
<span id="cb5-73"><a href="#cb5-73"></a>  output_files&lt;-<span class="st"> </span><span class="kw">list.files</span>(bg_dir,</span>
<span id="cb5-74"><a href="#cb5-74"></a>                            <span class="dt">pattern=</span> <span class="kw">glob2rx</span>(<span class="kw">paste0</span>(set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_On_pooled_&quot;</span>,set1,<span class="st">&quot;_&quot;</span>,set2,</span>
<span id="cb5-75"><a href="#cb5-75"></a>                                                    <span class="st">&quot;_hotspot_footprint_depth_table&quot;</span>,<span class="st">&quot;.csv&quot;</span>)),</span>
<span id="cb5-76"><a href="#cb5-76"></a>                            <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</span>
<span id="cb5-77"><a href="#cb5-77"></a>  <span class="cf">if</span> (<span class="kw">length</span>(output_files)<span class="op">==</span><span class="dv">0</span>) {</span>
<span id="cb5-78"><a href="#cb5-78"></a>    start_motif&lt;-<span class="dv">1</span></span>
<span id="cb5-79"><a href="#cb5-79"></a>  } <span class="cf">else</span>{</span>
<span id="cb5-80"><a href="#cb5-80"></a>    <span class="co"># Resume: infer starting motif index from the last output folder name</span></span>
<span id="cb5-81"><a href="#cb5-81"></a>    start_motif&lt;-<span class="kw">dirname</span>(output_files) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># directory name</span></span>
<span id="cb5-82"><a href="#cb5-82"></a><span class="st">      </span><span class="kw">str_split</span>(.,<span class="st">&quot;</span><span class="ch">\\</span><span class="st">_&quot;</span>, <span class="dt">simplify =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st">   </span><span class="co"># separate by underscore</span></span>
<span id="cb5-83"><a href="#cb5-83"></a><span class="st">      </span><span class="kw">as.data.frame</span> (<span class="dt">stringsAsFactors=</span>F)<span class="op">%&gt;%</span></span>
<span id="cb5-84"><a href="#cb5-84"></a><span class="st">      </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="kw">tail</span>(<span class="kw">names</span>(.), <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># keep only the last column</span></span>
<span id="cb5-85"><a href="#cb5-85"></a><span class="st">      </span><span class="kw">mutate_if</span>(is.character,as.numeric) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#convert to numeric</span></span>
<span id="cb5-86"><a href="#cb5-86"></a><span class="st">      </span>max<span class="op">+</span><span class="dv">25</span> <span class="co">#Identify the last processed index and increment by 25 to start the next batch</span></span>
<span id="cb5-87"><a href="#cb5-87"></a>  }</span>
<span id="cb5-88"><a href="#cb5-88"></a></span>
<span id="cb5-89"><a href="#cb5-89"></a><span class="co"># Run MASA in batches of 25 motifs</span></span>
<span id="cb5-90"><a href="#cb5-90"></a>  <span class="cf">if</span> (start_motif<span class="op">&lt;</span>motif_no) { </span>
<span id="cb5-91"><a href="#cb5-91"></a>  </span>
<span id="cb5-92"><a href="#cb5-92"></a>    <span class="cf">for</span> (r <span class="cf">in</span> <span class="kw">seq</span>(start_motif, motif_no, <span class="dt">by =</span> <span class="dv">25</span>)) {</span>
<span id="cb5-93"><a href="#cb5-93"></a>      GFoot_obj &lt;-<span class="st"> </span><span class="kw">GFoot</span>(</span>
<span id="cb5-94"><a href="#cb5-94"></a>      <span class="dt">control =</span> <span class="kw">get</span>(set1),</span>
<span id="cb5-95"><a href="#cb5-95"></a>      <span class="dt">treatment =</span> <span class="kw">get</span>(set2),</span>
<span id="cb5-96"><a href="#cb5-96"></a>      <span class="dt">sitefile =</span> <span class="kw">paste0</span>(<span class="st">&quot;pooled_&quot;</span>,set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_hotspot.csv&quot;</span>),</span>
<span id="cb5-97"><a href="#cb5-97"></a>      <span class="dt">motifDB =</span> motifdb_mm,</span>
<span id="cb5-98"><a href="#cb5-98"></a>      <span class="dt">gfootoption =</span> gfootoption_couple,</span>
<span id="cb5-99"><a href="#cb5-99"></a>      <span class="dt">outputdir =</span> <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;OUTPUT_&quot;</span>, c, <span class="st">&quot;_&quot;</span>, r)),</span>
<span id="cb5-100"><a href="#cb5-100"></a>      <span class="dt">cachedir =</span> <span class="kw">file.path</span>(bg_dir, <span class="kw">paste0</span>(<span class="st">&quot;CACHE_&quot;</span>, c, <span class="st">&quot;_&quot;</span>, r))</span>
<span id="cb5-101"><a href="#cb5-101"></a>      )</span>
<span id="cb5-102"><a href="#cb5-102"></a></span>
<span id="cb5-103"><a href="#cb5-103"></a>    <span class="kw">run</span>(</span>
<span id="cb5-104"><a href="#cb5-104"></a>      GFoot_obj,</span>
<span id="cb5-105"><a href="#cb5-105"></a>      <span class="dt">graphout =</span> T,</span>
<span id="cb5-106"><a href="#cb5-106"></a>      <span class="dt">yrange =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">2.2</span>, <span class="fl">1.0</span>),</span>
<span id="cb5-107"><a href="#cb5-107"></a>      <span class="dt">mc.cores =</span> numcores,</span>
<span id="cb5-108"><a href="#cb5-108"></a>      <span class="dt">range=</span>r<span class="op">:</span><span class="kw">ifelse</span>(r<span class="op">+</span><span class="dv">24</span><span class="op">&lt;</span>motif_no,r<span class="op">+</span><span class="dv">24</span>,motif_no), </span>
<span id="cb5-109"><a href="#cb5-109"></a>      <span class="dt">run_set=</span>c</span>
<span id="cb5-110"><a href="#cb5-110"></a>    )</span>
<span id="cb5-111"><a href="#cb5-111"></a>    <span class="kw">gc</span>() <span class="co">#garbage collector</span></span>
<span id="cb5-112"><a href="#cb5-112"></a>  }</span>
<span id="cb5-113"><a href="#cb5-113"></a></span>
<span id="cb5-114"><a href="#cb5-114"></a>  <span class="kw">setwd</span>(bg_dir)</span>
<span id="cb5-115"><a href="#cb5-115"></a></span>
<span id="cb5-116"><a href="#cb5-116"></a><span class="co"># Merge footprint depth tables produced for all motif batches </span></span>
<span id="cb5-117"><a href="#cb5-117"></a><span class="co"># (central + flanking accessibility information for all motifs)</span></span>
<span id="cb5-118"><a href="#cb5-118"></a></span>
<span id="cb5-119"><a href="#cb5-119"></a>  merge_output&lt;-<span class="kw">paste0</span>(<span class="st">&quot;find  . -type f -name &#39;&quot;</span>,</span>
<span id="cb5-120"><a href="#cb5-120"></a>                        set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_On_pooled_&quot;</span>,set1,<span class="st">&quot;_&quot;</span>,set2,</span>
<span id="cb5-121"><a href="#cb5-121"></a>                        <span class="st">&quot;_hotspot_footprint_depth_table.csv&#39; -exec tail -n +2 -q {} &#39;;&#39;&quot;</span>,</span>
<span id="cb5-122"><a href="#cb5-122"></a>                        <span class="st">&quot;&gt;&quot;</span>,set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_On_pooled_&quot;</span>,</span>
<span id="cb5-123"><a href="#cb5-123"></a>                         set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_hotspot_footprint_depth_table_merged.csv&quot;</span>)</span>
<span id="cb5-124"><a href="#cb5-124"></a>  </span>
<span id="cb5-125"><a href="#cb5-125"></a>    <span class="kw">system</span>(merge_output)</span>
<span id="cb5-126"><a href="#cb5-126"></a>    </span>
<span id="cb5-127"><a href="#cb5-127"></a>    <span class="co">#read the merged footprint depth table</span></span>
<span id="cb5-128"><a href="#cb5-128"></a><span class="co"># This table includes both central (motif) and flanking accessibility metrics</span></span>
<span id="cb5-129"><a href="#cb5-129"></a></span>
<span id="cb5-130"><a href="#cb5-130"></a>    dat=<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste0</span>(bg_dir,set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_On_pooled_&quot;</span>,set1,<span class="st">&quot;_&quot;</span>,set2,<span class="st">&quot;_hotspot_footprint_depth_table_merged.csv&quot;</span>), <span class="dt">quote=</span><span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span>, <span class="dt">comment.char=</span><span class="st">&quot;&quot;</span>) </span>
<span id="cb5-131"><a href="#cb5-131"></a>    </span>
<span id="cb5-132"><a href="#cb5-132"></a>    <span class="co">#add column names</span></span>
<span id="cb5-133"><a href="#cb5-133"></a>    <span class="kw">colnames</span>(dat)&lt;-<span class="kw">c</span>(<span class="st">&quot;num&quot;</span>,<span class="st">&quot;filename&quot;</span>,<span class="st">&quot;center&quot;</span>,<span class="st">&quot;logo&quot;</span>,<span class="st">&quot;motiflength&quot;</span>,<span class="st">&quot;motif&quot;</span>,<span class="st">&quot;memeNo&quot;</span>,<span class="st">&quot;memeEntry&quot;</span>,<span class="st">&quot;lrmotif&quot;</span>,<span class="st">&quot;lrflanking&quot;</span>,</span>
<span id="cb5-134"><a href="#cb5-134"></a>                     <span class="st">&quot;lrtotal&quot;</span>,<span class="st">&quot;fdepth1&quot;</span>,<span class="st">&quot;fdepth2&quot;</span>,<span class="st">&quot;meancc1&quot;</span>,<span class="st">&quot;meancc2&quot;</span>,<span class="st">&quot;numsite&quot;</span>)</span>
<span id="cb5-135"><a href="#cb5-135"></a>    </span>
<span id="cb5-136"><a href="#cb5-136"></a> <span class="co"># Generate MASA plots and interactive report </span></span>
<span id="cb5-137"><a href="#cb5-137"></a><span class="co"># The bagplot summarizes TF activity changes based on flanking + motif-core accessibility</span></span>
<span id="cb5-138"><a href="#cb5-138"></a></span>
<span id="cb5-139"><a href="#cb5-139"></a>   test_gen&lt;-<span class="kw">gen_bagplot_masa</span>(dat,</span>
<span id="cb5-140"><a href="#cb5-140"></a>                              <span class="dt">dataname1=</span>set1,</span>
<span id="cb5-141"><a href="#cb5-141"></a>                              <span class="dt">dataname2=</span>set2,</span>
<span id="cb5-142"><a href="#cb5-142"></a>                              <span class="dt">qvaluethreshold_bagplot=</span><span class="fl">0.05</span>,</span>
<span id="cb5-143"><a href="#cb5-143"></a>                              <span class="dt">factor=</span><span class="fl">1.5</span>,</span>
<span id="cb5-144"><a href="#cb5-144"></a>                              <span class="dt">pdf =</span> <span class="ot">TRUE</span>,</span>
<span id="cb5-145"><a href="#cb5-145"></a>                              <span class="dt">html=</span><span class="ot">TRUE</span>,</span>
<span id="cb5-146"><a href="#cb5-146"></a>                              <span class="dt">include_homer_results =</span> <span class="ot">TRUE</span>,</span>
<span id="cb5-147"><a href="#cb5-147"></a>                              <span class="dt">homer_results_file =</span> homer_results_file,</span>
<span id="cb5-148"><a href="#cb5-148"></a>                              <span class="dt">pval_threshold_homer =</span> <span class="fl">0.05</span>)</span>
<span id="cb5-149"><a href="#cb5-149"></a>   </span>
<span id="cb5-150"><a href="#cb5-150"></a>     <span class="kw">dev.off</span>()</span>
<span id="cb5-151"><a href="#cb5-151"></a>  }</span>
<span id="cb5-152"><a href="#cb5-152"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Session info for reproducibility/debugging</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">sessionInfo</span>()</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; R version 4.0.3 (2020-10-10)</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt; Running under: Ubuntu 20.04.1 LTS</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt; </span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/atlas/libblas.so.3.10.3</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/atlas/liblapack.so.3.10.3</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; </span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt; locale:</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt;  [1] LC_CTYPE=en_IL.UTF-8       LC_NUMERIC=C              </span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt;  [3] LC_TIME=en_IL.UTF-8        LC_COLLATE=en_IL.UTF-8    </span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt;  [5] LC_MONETARY=en_IL.UTF-8    LC_MESSAGES=en_IL.UTF-8   </span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt;  [7] LC_PAPER=en_IL.UTF-8       LC_NAME=C                 </span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt;  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#&gt; [11] LC_MEASUREMENT=en_IL.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co">#&gt; </span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt; </span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">#&gt;  [1] digest_0.6.39     R6_2.6.1          lifecycle_1.0.4   jsonlite_2.0.0   </span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co">#&gt;  [5] evaluate_1.0.5    cachem_1.1.0      rlang_1.1.6       cli_3.6.5        </span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#&gt;  [9] otel_0.2.0        rstudioapi_0.17.1 jquerylib_0.1.4   bslib_0.9.0      </span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co">#&gt; [13] rmarkdown_2.30    tools_4.0.3       xfun_0.55         yaml_2.3.12      </span></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co">#&gt; [17] fastmap_1.2.0     compiler_4.0.3    htmltools_0.5.9   knitr_1.51       </span></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="co">#&gt; [21] sass_0.4.10</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
